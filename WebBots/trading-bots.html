<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>DFirst Trading Bots - Automated Trading</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      color-scheme: dark;
      --bg: #0f1117;
      --panel: #171b24;
      --panel-strong: #1f2531;
      --panel-soft: rgba(23, 27, 36, 0.9);
      --accent: #00d2ff;
      --accent-2: #ff7a18;
      --text: #f5f7ff;
      --muted: #98a2bd;
      --border: rgba(255,255,255,0.08);
      --success: #24d970;
      --danger: #ff5f6d;
      --warning: #fcd34d;
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      font-family: 'Inter', system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      background: radial-gradient(circle at top right, rgba(0, 210, 255, 0.25), transparent 40%), var(--bg);
      color: var(--text);
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }

    .grid-bg {
      position: fixed;
      inset: 0;
      pointer-events: none;
      background-image: 
        linear-gradient(rgba(0, 210, 255, 0.03) 1px, transparent 1px),
        linear-gradient(90deg, rgba(0, 210, 255, 0.03) 1px, transparent 1px);
      background-size: 32px 32px;
      z-index: 0;
    }

    .page {
      position: relative;
      z-index: 1;
      width: 100%;
      max-width: 1400px;
      margin: 0 auto;
      min-height: 100vh;
      padding: 24px;
      padding-bottom: 100px;
      display: flex;
      flex-direction: column;
      gap: 24px;
    }

    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 16px;
      margin-bottom: 8px;
    }

    .header h1 {
      margin: 0;
      font-size: 28px;
      font-weight: 700;
      color: var(--text);
      letter-spacing: -0.02em;
    }

    .back-btn {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 10px 16px;
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: 10px;
      color: var(--text);
      text-decoration: none;
      font-size: 14px;
      font-weight: 500;
      transition: all 0.2s ease;
      font-family: 'Inter', system-ui, sans-serif;
    }

    .back-btn:hover {
      background: var(--panel-strong);
      border-color: rgba(255, 255, 255, 0.12);
      transform: translateY(-1px);
    }

    .section-heading {
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .section-heading h2 {
      margin: 0;
      font-size: 20px;
      font-weight: 600;
      color: var(--text);
    }

    .section-heading p {
      margin: 0;
      color: var(--muted);
      font-size: 14px;
    }

    .bots-layout {
      display: flex;
      gap: 24px;
      align-items: flex-start;
      width: 100%;
    }

    .bots-list {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
      gap: 20px;
      flex: 1;
      max-width: 420px;
    }

    .bot-card {
      background: var(--panel);
      border-radius: 18px;
      padding: 24px;
      border: 1px solid var(--border);
      box-shadow: 0 8px 24px rgba(0, 0, 0, 0.3);
      transition: all 0.3s ease;
      cursor: pointer;
      position: relative;
      overflow: hidden;
    }

    .bot-card::after {
      content: "";
      position: absolute;
      inset: 0;
      border-radius: inherit;
      border: 1px solid transparent;
      background: linear-gradient(120deg, rgba(0, 210, 255, 0.35), rgba(255, 122, 24, 0.2));
      opacity: 0;
      transition: opacity 0.3s ease;
      z-index: 0;
    }

    .bot-card.active::after,
    .bot-card:hover::after {
      opacity: 1;
    }

    .bot-card-content {
      position: relative;
      z-index: 1;
      display: flex;
      flex-direction: column;
      gap: 14px;
    }

    .bot-chip {
      display: inline-flex;
      padding: 4px 10px;
      border-radius: 999px;
      background: rgba(0, 210, 255, 0.12);
      border: 1px solid rgba(0, 210, 255, 0.25);
      color: #00d2ff;
      font-size: 12px;
      font-weight: 600;
      letter-spacing: 0.05em;
      text-transform: uppercase;
    }

    .bot-card h3 {
      margin: 0;
      font-size: 20px;
      font-weight: 700;
      color: var(--text);
      letter-spacing: -0.01em;
    }

    .bot-card p {
      margin: 0;
      font-size: 14px;
      color: var(--muted);
      line-height: 1.6;
    }

    .bot-meta {
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
      margin: 0;
      padding: 0;
      list-style: none;
    }

    .bot-meta li {
      padding: 6px 12px;
      border-radius: 8px;
      background: rgba(255, 255, 255, 0.04);
      border: 1px solid rgba(255, 255, 255, 0.08);
      font-size: 12px;
      color: var(--muted);
    }

    .open-bot-btn {
      margin-top: auto;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      padding: 12px 18px;
      border-radius: 10px;
      border: 1px solid rgba(255, 255, 255, 0.12);
      background: rgba(255, 255, 255, 0.04);
      color: var(--text);
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s ease;
      font-family: inherit;
    }

    .open-bot-btn:hover {
      background: rgba(0, 210, 255, 0.15);
      border-color: rgba(0, 210, 255, 0.4);
    }

    .bot-detail-panel {
      flex: 1.4;
      background: var(--panel-soft);
      border-radius: 20px;
      border: 1px solid var(--border);
      padding: 24px;
      min-height: 520px;
      display: flex;
      flex-direction: column;
      gap: 24px;
    }

    .panel-placeholder {
      flex: 1;
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--muted);
      font-size: 15px;
      text-align: center;
    }

    .bot-config,
    .bot-stats {
      background: rgba(15, 17, 23, 0.6);
      border: 1px solid rgba(255, 255, 255, 0.05);
      border-radius: 16px;
      padding: 20px;
      display: flex;
      flex-direction: column;
      gap: 20px;
    }

    .bot-config h4,
    .bot-stats h4 {
      margin: 0;
      font-size: 18px;
      font-weight: 600;
    }

    .config-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 16px;
    }

    .input-group {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .input-group label {
      font-size: 13px;
      font-weight: 600;
      color: var(--muted);
      letter-spacing: 0.05em;
      text-transform: uppercase;
    }

    .input-group input {
      width: 100%;
      padding: 12px 14px;
      border-radius: 10px;
      border: 1px solid rgba(255, 255, 255, 0.12);
      background: rgba(15, 17, 23, 0.8);
      color: var(--text);
      font-size: 14px;
      font-family: inherit;
    }

    .input-group small {
      color: rgba(152, 162, 189, 0.75);
      font-size: 12px;
      line-height: 1.4;
    }

    .config-actions {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      align-items: center;
    }

    .primary-btn,
    .secondary-btn {
      padding: 12px 20px;
      border-radius: 10px;
      border: none;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s ease;
      font-family: inherit;
    }

    .primary-btn {
      background: linear-gradient(135deg, rgba(0, 210, 255, 0.35), rgba(0, 210, 255, 0.15));
      border: 1px solid rgba(0, 210, 255, 0.6);
      color: #00d2ff;
    }

    .primary-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .secondary-btn {
      background: rgba(255, 255, 255, 0.04);
      border: 1px solid rgba(255, 255, 255, 0.12);
      color: var(--text);
    }

    .secondary-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .status-badge {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 6px 12px;
      border-radius: 999px;
      font-size: 12px;
      font-weight: 600;
      letter-spacing: 0.05em;
      text-transform: uppercase;
    }

    .status-badge[data-state="idle"] {
      background: rgba(255, 255, 255, 0.05);
      color: var(--muted);
      border: 1px solid rgba(255, 255, 255, 0.08);
    }

    .status-badge[data-state="running"] {
      background: rgba(36, 217, 112, 0.1);
      color: var(--success);
      border: 1px solid rgba(36, 217, 112, 0.3);
    }

    .status-badge[data-state="error"] {
      background: rgba(255, 68, 79, 0.12);
      color: var(--danger);
      border: 1px solid rgba(255, 68, 79, 0.3);
    }

    .status-text {
      font-size: 13px;
      color: var(--muted);
    }

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
      gap: 16px;
    }

    .stat-card {
      padding: 16px;
      border-radius: 12px;
      background: rgba(255, 255, 255, 0.03);
      border: 1px solid rgba(255, 255, 255, 0.05);
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .stat-label {
      font-size: 12px;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      color: var(--muted);
    }

    .stat-value {
      font-size: 20px;
      font-weight: 700;
      letter-spacing: -0.01em;
    }

    .stat-value.positive {
      color: var(--success);
    }

    .stat-value.negative {
      color: var(--danger);
    }

    .history-list {
      display: flex;
      flex-direction: column;
      gap: 10px;
      max-height: 220px;
      overflow-y: auto;
      padding-right: 6px;
    }

    .history-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px 12px;
      border-radius: 10px;
      background: rgba(255, 255, 255, 0.02);
      border: 1px solid rgba(255, 255, 255, 0.05);
      font-size: 13px;
    }

    .history-item.win {
      border-color: rgba(36, 217, 112, 0.3);
    }

    .history-item.loss {
      border-color: rgba(255, 68, 79, 0.3);
    }

    .history-meta {
      display: flex;
      flex-direction: column;
      gap: 4px;
      color: var(--muted);
    }

    .history-profit {
      font-weight: 600;
    }

    .history-profit.win {
      color: var(--success);
    }

    .history-profit.loss {
      color: var(--danger);
    }

    footer {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      padding: 16px 24px;
      background: rgba(15, 17, 23, 0.95);
      backdrop-filter: blur(10px);
      border-top: 1px solid rgba(255, 255, 255, 0.08);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 10;
    }

    .footer-content {
      display: flex;
      align-items: center;
      gap: 24px;
      flex-wrap: wrap;
      justify-content: center;
      width: 100%;
      max-width: 1400px;
      margin: 0 auto;
    }

    .footer-text {
      font-size: 13px;
      color: rgba(152, 162, 189, 0.8);
      font-family: 'Inter', system-ui, sans-serif;
    }

    .powered-by {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 13px;
      color: rgba(152, 162, 189, 0.8);
      font-family: 'Inter', system-ui, sans-serif;
    }

    .powered-by span:last-child {
      font-size: 15px;
      font-weight: 700;
      color: #ff444f;
      text-transform: lowercase;
      letter-spacing: 0.06em;
    }

    @media (max-width: 1024px) {
      .bots-layout {
        flex-direction: column;
      }

      .bots-list {
        max-width: none;
        width: 100%;
      }
    }

    @media (max-width: 768px) {
      .page {
        padding: 20px 16px;
        padding-bottom: 90px;
      }

      .header {
        flex-direction: column;
        align-items: flex-start;
      }

      .header h1 {
        font-size: 24px;
      }

      .bot-detail-panel {
        padding: 18px;
      }

      .config-grid {
        grid-template-columns: 1fr;
      }

      .config-actions {
        flex-direction: column;
        align-items: stretch;
      }

      .primary-btn,
      .secondary-btn {
        width: 100%;
        justify-content: center;
      }

      footer {
        padding: 14px 16px;
      }

      .footer-content {
        flex-direction: column;
        gap: 10px;
        text-align: center;
      }

      .footer-text,
      .powered-by {
        font-size: 12px;
      }
    }

    @media (max-width: 480px) {
      .page {
        padding-bottom: 85px;
      }

      footer {
        padding: 12px 16px;
      }

      .footer-content {
        gap: 8px;
      }

      .footer-text,
      .powered-by {
        font-size: 11px;
      }
    }
  </style>
</head>
<body>
  <div class="grid-bg"></div>
  <main class="page">
    <div class="header">
      <h1>Automated Trading Bots</h1>
      <a href="index.html" class="back-btn">
        ← Back to Dashboard
      </a>
    </div>

    <div class="section-heading">
      <h2>Deriv Bots</h2>
      <p>Each bot executes trades one at a time using your Deriv OAuth/API connection (app_id 67709).</p>
    </div>

    <div class="bots-layout">
      <div class="bots-list">
        <div class="bot-card active" id="allMarketsDifferCard">
          <div class="bot-card-content">
            <span class="bot-chip">Digits Differ</span>
            <h3>All Markets Differ</h3>
            <p>Cycles through Volatility 10–100 markets, executing single Digit Differ contracts with smart rotation and martingale recovery.</p>
            <ul class="bot-meta">
              <li>Stake: $1 default</li>
              <li>Martingale ×16</li>
              <li>Take Profit: $100</li>
              <li>Stop Loss: $1000</li>
            </ul>
            <button class="open-bot-btn" id="openAllMarketsDiffer">Open Bot</button>
          </div>
        </div>
      </div>

      <div class="bot-detail-panel" id="botDetailPanel">
        <div class="panel-placeholder" id="panelPlaceholder">
          Select a bot card to configure and start automated trading.
        </div>

        <div class="bot-config" id="botConfig" hidden>
          <div class="config-header">
            <div class="status-badge" id="botStatusBadge" data-state="idle">Idle</div>
            <div class="status-text" id="botStatusText">Waiting for bot configuration.</div>
          </div>
          <h4>Configuration</h4>
          <div class="config-grid">
            <div class="input-group">
              <label for="stakeInput">Initial Stake (USD)</label>
              <input type="number" id="stakeInput" min="0.35" step="0.01" value="1">
              <small>Default $1. Minimum $0.35. Adjust to match your balance and risk tolerance.</small>
            </div>
            <div class="input-group">
              <label for="takeProfitInput">Take Profit (USD)</label>
              <input type="number" id="takeProfitInput" min="5" step="1" value="100">
              <small>Bot stops automatically once this profit target is reached.</small>
            </div>
            <div class="input-group">
              <label for="stopLossInput">Stop Loss (USD)</label>
              <input type="number" id="stopLossInput" min="50" step="1" value="1000">
              <small>Bot halts immediately if losses reach this amount.</small>
            </div>
            <div class="input-group">
              <label for="martingaleInput">Martingale Multiplier</label>
              <input type="number" id="martingaleInput" min="1" step="0.1" value="16">
              <small>Default ×16 (same as Differ bots in the app). Applies after each loss.</small>
            </div>
          </div>

          <div class="config-actions">
            <button class="primary-btn" id="startBotBtn">Start Bot</button>
            <button class="secondary-btn" id="stopBotBtn" disabled>Stop Bot</button>
            <div class="status-text" id="accountHint">Connect your Deriv account from the dashboard before running bots.</div>
          </div>
        </div>

        <div class="bot-stats" id="botStats" hidden>
          <h4>Live Performance</h4>
          <div class="stats-grid">
            <div class="stat-card">
              <span class="stat-label">Account Balance</span>
              <span class="stat-value" id="balanceValue">-</span>
            </div>
            <div class="stat-card">
              <span class="stat-label">Total Profit</span>
              <span class="stat-value" id="totalProfitValue">$0.00</span>
            </div>
            <div class="stat-card">
              <span class="stat-label">Total Trades</span>
              <span class="stat-value" id="totalTradesValue">0</span>
            </div>
            <div class="stat-card">
              <span class="stat-label">Win Rate</span>
              <span class="stat-value" id="winRateValue">0%</span>
            </div>
            <div class="stat-card">
              <span class="stat-label">Current Stake</span>
              <span class="stat-value" id="currentStakeValue">$0.00</span>
            </div>
            <div class="stat-card">
              <span class="stat-label">Consecutive Losses</span>
              <span class="stat-value" id="consecutiveLossesValue">0</span>
            </div>
            <div class="stat-card">
              <span class="stat-label">Market / Digit</span>
              <span class="stat-value" id="targetValue">-</span>
            </div>
            <div class="stat-card">
              <span class="stat-label">Running Time</span>
              <span class="stat-value" id="runningTimeValue">00:00:00</span>
            </div>
          </div>

          <div>
            <h4 style="margin-bottom: 12px;">Recent Trades</h4>
            <div class="history-list" id="historyList">
              <!-- Trades injected here -->
            </div>
          </div>
        </div>
      </div>
    </div>
  </main>

  <footer>
    <div class="footer-content">
      <div class="footer-text">© <span id="year"></span> DFirst Automation Lab</div>
      <div class="powered-by">
        <span>Powered by</span>
        <span>deriv</span>
      </div>
    </div>
  </footer>

  <script>
    const APP_ID = '67709';
    const DERIV_WS_URL = `wss://ws.binaryws.com/websockets/v3?app_id=${APP_ID}`;
    const DERIV_OAUTH_TOKENS_KEY = '@deriv_oauth_tokens';
    const DERIV_API_KEY_KEY = '@deriv_api_key';
    const VOLATILITY_MARKETS = ['R_10', 'R_25', 'R_50', 'R_75', 'R_100'];
    const BOT_DEFAULTS = {
      initialStake: 1,
      minStake: 0.35,
      takeProfit: 100,
      stopLoss: 1000,
      martingaleMultiplier: 16
    };

    document.getElementById('year').textContent = new Date().getFullYear();

    const botCard = document.getElementById('allMarketsDifferCard');
    const openBotBtn = document.getElementById('openAllMarketsDiffer');
    const panelPlaceholder = document.getElementById('panelPlaceholder');
    const botConfig = document.getElementById('botConfig');
    const botStats = document.getElementById('botStats');

    function openBotPanel() {
      panelPlaceholder.hidden = true;
      botConfig.hidden = false;
      botStats.hidden = false;
      botCard.classList.add('active');
    }

    botCard.addEventListener('click', () => {
      openBotPanel();
      botConfig.scrollIntoView({ behavior: 'smooth', block: 'center' });
    });

    openBotBtn.addEventListener('click', (event) => {
      event.stopPropagation();
      openBotPanel();
      botConfig.scrollIntoView({ behavior: 'smooth', block: 'center' });
    });

    class AllMarketsDifferBot {
      constructor(ui) {
        this.ui = ui;
        this.ws = null;
        this.isRunning = false;
        this.stopRequested = false;
        this.stopMessage = null;
        this.config = { ...BOT_DEFAULTS };
        this.currentStake = BOT_DEFAULTS.initialStake;
        this.activeContractId = null;
        this.tradeInProgress = false;
        this.lastMarket = null;
        this.lastDigit = null;
        this.currentMarket = null;
        this.currentDigit = null;
        this.totalProfit = 0;
        this.totalTrades = 0;
        this.wins = 0;
        this.consecutiveLosses = 0;
        this.tradeHistory = [];
        this.balance = 0;
        this.accountCurrency = 'USD';
        this.startTime = null;
        this.runningTimer = null;
      }

      async start(config) {
        if (this.isRunning) {
          this.ui.showStatus('Bot is already running. Stop it before starting again.', 'warning');
          return;
        }

        const token = resolveAuthToken();
        if (!token) {
          this.ui.showStatus('Connect your Deriv account on the dashboard before running bots.', 'error');
          return;
        }

        this.config = { ...this.config, ...config };
        this.resetStats();
        this.ui.resetHistory();
        this.ui.updateStats(this.getStatsSnapshot());
        this.ui.setRunningState(true);
        this.ui.showStatus('Authorizing with Deriv...', 'info');

        this.isRunning = true;
        this.stopRequested = false;
        this.startTime = new Date();
        this.startRunningTimer();

        this.ws = new WebSocket(DERIV_WS_URL);

        this.ws.onopen = () => {
          this.ws.send(JSON.stringify({ authorize: token }));
        };

        this.ws.onmessage = (event) => this.handleMessage(event.data);

        this.ws.onerror = () => {
          this.ui.showStatus('WebSocket error. Stopping bot.', 'error');
          this.stop('Connection error', 'error');
        };

        this.ws.onclose = () => {
          if (this.stopRequested) {
            this.finishStop();
          } else {
            this.stopMessage = { message: 'Connection closed unexpectedly.', type: 'error' };
            this.finishStop();
          }
        };
      }

      stop(message = 'Bot stopped', type = 'info') {
        if (!this.isRunning && !this.ws) {
          this.ui.showStatus('Bot is already stopped.', 'warning');
          return;
        }
        this.stopRequested = true;
        this.stopMessage = { message, type };
        if (this.ws && (this.ws.readyState === WebSocket.OPEN || this.ws.readyState === WebSocket.CONNECTING)) {
          this.ws.close();
        } else {
          this.finishStop();
        }
      }

      finishStop() {
        this.isRunning = false;
        this.tradeInProgress = false;
        this.activeContractId = null;
        this.ws = null;
        this.clearRunningTimer();
        this.ui.setRunningState(false);
        if (this.stopMessage) {
          this.ui.showStatus(this.stopMessage.message, this.stopMessage.type);
          this.stopMessage = null;
        }
      }

      handleMessage(raw) {
        try {
          const data = JSON.parse(raw);

          if (data.error) {
            const message = data.error.message || 'Deriv returned an error.';
            this.ui.showStatus(message, 'error');
            this.stop(message, 'error');
            return;
          }

          switch (data.msg_type) {
            case 'authorize':
              this.accountCurrency = data.authorize.currency || 'USD';
              this.balance = Number(data.authorize.balance) || 0;
              this.ui.updateBalance(this.balance, this.accountCurrency);
              this.ui.showStatus('Connected. Starting digit differ sequence...', 'success');

              this.subscribeToBalance();
              this.subscribeToContracts();
              this.queueNextTrade();
              break;
            case 'balance':
              if (typeof data.balance?.balance !== 'undefined') {
                this.balance = Number(data.balance.balance);
                this.ui.updateBalance(this.balance, data.balance.currency || this.accountCurrency);
              }
              break;
            case 'proposal':
              if (this.isRunning && data.proposal?.id && this.ws?.readyState === WebSocket.OPEN) {
                this.ws.send(JSON.stringify({
                  buy: data.proposal.id,
                  price: data.proposal.ask_price
                }));
              }
              break;
            case 'buy':
              if (data.buy?.contract_id) {
                this.activeContractId = data.buy.contract_id;
              }
              break;
            case 'proposal_open_contract':
              this.handleContractUpdate(data.proposal_open_contract);
              break;
            default:
              break;
          }
        } catch (error) {
          console.error('Error handling message', error);
        }
      }

      subscribeToBalance() {
        if (!this.ws || this.ws.readyState !== WebSocket.OPEN) return;
        this.ws.send(JSON.stringify({ balance: 1, subscribe: 1 }));
      }

      subscribeToContracts() {
        if (!this.ws || this.ws.readyState !== WebSocket.OPEN) return;
        this.ws.send(JSON.stringify({ proposal_open_contract: 1, subscribe: 1 }));
      }

      queueNextTrade() {
        if (!this.isRunning || this.tradeInProgress) {
          return;
        }

        if (!this.ws || this.ws.readyState !== WebSocket.OPEN) {
          this.stop('Connection closed. Please restart the bot.', 'error');
          return;
        }

        const market = this.getNextMarket();
        const digit = this.getNextDigit();

        this.tradeInProgress = true;
        this.currentMarket = market;
        this.currentDigit = digit;
        this.ui.updateTargets(market, digit);

        const proposal = {
          proposal: 1,
          amount: this.currentStake.toFixed(2),
          basis: 'stake',
          contract_type: 'DIGITDIFF',
          currency: this.accountCurrency || 'USD',
          duration: 1,
          duration_unit: 't',
          symbol: market,
          barrier: digit.toString()
        };

        this.ws.send(JSON.stringify(proposal));
      }

      getNextMarket() {
        const options = VOLATILITY_MARKETS.filter((m) => m !== this.lastMarket);
        if (options.length === 0) {
          return VOLATILITY_MARKETS[Math.floor(Math.random() * VOLATILITY_MARKETS.length)];
        }
        const market = options[Math.floor(Math.random() * options.length)];
        this.lastMarket = market;
        return market;
      }

      getNextDigit() {
        let digit = Math.floor(Math.random() * 10);
        if (digit === this.lastDigit) {
          digit = (digit + 3) % 10;
        }
        this.lastDigit = digit;
        return digit;
      }

      handleContractUpdate(contract) {
        if (!contract || !contract.contract_id) return;
        if (this.activeContractId && contract.contract_id !== this.activeContractId) return;

        if (contract.is_sold) {
          const profit = parseFloat(contract.profit) || 0;
          const win = profit > 0;

          this.updateStats({
            profit,
            win,
            market: this.currentMarket,
            digit: this.currentDigit,
            stake: this.currentStake
          });

          this.tradeInProgress = false;
          this.activeContractId = null;

          if (this.shouldStop()) {
            return;
          }

          setTimeout(() => this.queueNextTrade(), 900);
        }
      }

      updateStats(tradeResult) {
        this.totalTrades += 1;
        if (tradeResult.win) {
          this.wins += 1;
          this.consecutiveLosses = 0;
          this.currentStake = this.config.initialStake;
        } else {
          this.consecutiveLosses += 1;
          this.currentStake = parseFloat((this.currentStake * this.config.martingaleMultiplier).toFixed(2));
        }

        this.totalProfit = parseFloat((this.totalProfit + tradeResult.profit).toFixed(2));
        this.ui.addHistoryEntry({
          ...tradeResult,
          timestamp: new Date()
        });

        this.ui.updateStats(this.getStatsSnapshot(tradeResult));
      }

      shouldStop() {
        if (this.config.takeProfit > 0 && this.totalProfit >= this.config.takeProfit) {
          this.stop('Take profit reached. Bot stopped.', 'success');
          return true;
        }

        if (this.config.stopLoss > 0 && this.totalProfit <= -Math.abs(this.config.stopLoss)) {
          this.stop('Stop loss hit. Bot stopped.', 'error');
          return true;
        }

        return false;
      }

      getStatsSnapshot(lastTrade) {
        const winRate = this.totalTrades > 0 ? ((this.wins / this.totalTrades) * 100).toFixed(2) : '0.00';
        return {
          balance: this.balance,
          currency: this.accountCurrency,
          totalProfit: this.totalProfit,
          totalTrades: this.totalTrades,
          winRate,
          currentStake: this.currentStake,
          consecutiveLosses: this.consecutiveLosses,
          market: this.currentMarket || '-',
          digit: typeof this.currentDigit === 'number' ? this.currentDigit : '-',
          lastProfit: lastTrade ? lastTrade.profit : 0,
          runningTime: this.getRunningTime()
        };
      }

      resetStats() {
        this.currentStake = this.config.initialStake;
        this.totalProfit = 0;
        this.totalTrades = 0;
        this.wins = 0;
        this.consecutiveLosses = 0;
        this.tradeHistory = [];
        this.lastMarket = null;
        this.lastDigit = null;
        this.activeContractId = null;
        this.tradeInProgress = false;
      }

      startRunningTimer() {
        this.clearRunningTimer();
        this.runningTimer = setInterval(() => {
          if (this.isRunning) {
            this.ui.updateRunningTime(this.getRunningTime());
          }
        }, 1000);
      }

      clearRunningTimer() {
        if (this.runningTimer) {
          clearInterval(this.runningTimer);
          this.runningTimer = null;
        }
      }

      getRunningTime() {
        if (!this.startTime) return '00:00:00';
        const diff = Math.max(0, Math.floor((Date.now() - this.startTime.getTime()) / 1000));
        const hours = Math.floor(diff / 3600).toString().padStart(2, '0');
        const minutes = Math.floor((diff % 3600) / 60).toString().padStart(2, '0');
        const seconds = (diff % 60).toString().padStart(2, '0');
        return `${hours}:${minutes}:${seconds}`;
      }
    }

    function resolveAuthToken() {
      try {
        const stored = localStorage.getItem(DERIV_OAUTH_TOKENS_KEY);
        if (stored) {
          const tokens = JSON.parse(stored);
          if (tokens?.selectedAccount?.token) {
            return tokens.selectedAccount.token;
          }
          if (Array.isArray(tokens?.accounts) && tokens.accounts.length) {
            return tokens.accounts[0].token;
          }
        }
      } catch (error) {
        console.error('Failed to read OAuth tokens', error);
      }

      try {
        const apiKey = localStorage.getItem(DERIV_API_KEY_KEY);
        if (apiKey) {
          return apiKey;
        }
      } catch (error) {
        console.error('Failed to read API key', error);
      }

      return null;
    }

    function initBotUI() {
      const startBtn = document.getElementById('startBotBtn');
      const stopBtn = document.getElementById('stopBotBtn');
      const statusBadge = document.getElementById('botStatusBadge');
      const statusText = document.getElementById('botStatusText');
      const balanceValue = document.getElementById('balanceValue');
      const totalProfitValue = document.getElementById('totalProfitValue');
      const totalTradesValue = document.getElementById('totalTradesValue');
      const winRateValue = document.getElementById('winRateValue');
      const currentStakeValue = document.getElementById('currentStakeValue');
      const consecutiveLossesValue = document.getElementById('consecutiveLossesValue');
      const targetValue = document.getElementById('targetValue');
      const runningTimeValue = document.getElementById('runningTimeValue');
      const historyList = document.getElementById('historyList');

      const stakeInput = document.getElementById('stakeInput');
      const takeProfitInput = document.getElementById('takeProfitInput');
      const stopLossInput = document.getElementById('stopLossInput');
      const martingaleInput = document.getElementById('martingaleInput');

      const historyLimit = 20;

      return {
        getConfigValues() {
          return {
            initialStake: parseFloat(stakeInput.value) || BOT_DEFAULTS.initialStake,
            takeProfit: parseFloat(takeProfitInput.value) || BOT_DEFAULTS.takeProfit,
            stopLoss: parseFloat(stopLossInput.value) || BOT_DEFAULTS.stopLoss,
            martingaleMultiplier: parseFloat(martingaleInput.value) || BOT_DEFAULTS.martingaleMultiplier
          };
        },
        validateConfig(config) {
          if (config.initialStake < BOT_DEFAULTS.minStake) {
            return { valid: false, message: `Minimum stake is $${BOT_DEFAULTS.minStake.toFixed(2)}.` };
          }
          if (config.takeProfit <= 0) {
            return { valid: false, message: 'Take profit must be greater than 0.' };
          }
          if (config.stopLoss <= 0) {
            return { valid: false, message: 'Stop loss must be greater than 0.' };
          }
          if (config.martingaleMultiplier < 1) {
            return { valid: false, message: 'Martingale multiplier must be at least 1.' };
          }
          return { valid: true };
        },
        setRunningState(isRunning) {
          startBtn.disabled = isRunning;
          stopBtn.disabled = !isRunning;
          statusBadge.dataset.state = isRunning ? 'running' : 'idle';
          statusBadge.textContent = isRunning ? 'Running' : 'Idle';
        },
        showStatus(message, type = 'info') {
          statusText.textContent = message;
          if (type === 'error') {
            statusBadge.dataset.state = 'error';
            statusBadge.textContent = 'Error';
          } else if (type === 'success') {
            statusBadge.dataset.state = 'running';
            statusBadge.textContent = 'Running';
          } else if (type === 'warning') {
            statusBadge.dataset.state = 'idle';
            statusBadge.textContent = 'Attention';
          } else if (!startBtn.disabled) {
            statusBadge.dataset.state = 'idle';
            statusBadge.textContent = 'Idle';
          }
        },
        updateBalance(value, currency = 'USD') {
          balanceValue.textContent = `${currency} ${Number(value).toFixed(2)}`;
        },
        updateStats(stats) {
          totalProfitValue.textContent = `${stats.totalProfit >= 0 ? '+' : ''}$${stats.totalProfit.toFixed(2)}`;
          totalProfitValue.classList.toggle('positive', stats.totalProfit > 0);
          totalProfitValue.classList.toggle('negative', stats.totalProfit < 0);
          totalTradesValue.textContent = stats.totalTrades;
          winRateValue.textContent = `${stats.winRate}%`;
          currentStakeValue.textContent = `$${Number(stats.currentStake).toFixed(2)}`;
          consecutiveLossesValue.textContent = stats.consecutiveLosses;
          targetValue.textContent = `${stats.market} / ${stats.digit}`;
          runningTimeValue.textContent = stats.runningTime;
        },
        updateTargets(market, digit) {
          targetValue.textContent = `${market} / ${digit}`;
        },
        updateRunningTime(value) {
          runningTimeValue.textContent = value;
        },
        resetHistory() {
          historyList.innerHTML = '';
        },
        addHistoryEntry(entry) {
          const item = document.createElement('div');
          item.className = `history-item ${entry.win ? 'win' : 'loss'}`;

          const meta = document.createElement('div');
          meta.className = 'history-meta';
          meta.innerHTML = `
            <strong>${entry.market} · Digit ${entry.digit}</strong>
            <span>${entry.timestamp.toLocaleTimeString()}</span>
            <span>Stake: $${Number(entry.stake).toFixed(2)}</span>
          `;

          const profit = document.createElement('div');
          profit.className = `history-profit ${entry.win ? 'win' : 'loss'}`;
          profit.textContent = `${entry.win ? '+' : ''}$${entry.profit.toFixed(2)}`;

          item.appendChild(meta);
          item.appendChild(profit);

          historyList.prepend(item);
          while (historyList.children.length > historyLimit) {
            historyList.removeChild(historyList.lastChild);
          }
        }
      };
    }

    const botUI = initBotUI();
    const allMarketsDifferBot = new AllMarketsDifferBot(botUI);

    document.getElementById('startBotBtn').addEventListener('click', () => {
      const config = botUI.getConfigValues();
      const validation = botUI.validateConfig(config);
      if (!validation.valid) {
        botUI.showStatus(validation.message, 'error');
        return;
      }
      allMarketsDifferBot.start(config);
    });

    document.getElementById('stopBotBtn').addEventListener('click', () => {
      allMarketsDifferBot.stop('Bot stopped by user.', 'warning');
    });
  </script>
</body>
</html>

